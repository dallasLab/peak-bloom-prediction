---
title: "Peak Bloom Prediction Demo"
author: "Eager Learner"
date: "01/01/2022"
output:
  html_document:
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE, 
                      message = FALSE,
                      fig.align = 'center',
                      out.width = '80%')
```

## Instructions

In this analysis we demonstrate a very simple way of predicting the peak bloom date in the coming decade for all four locations required by the competition.
The models used here are very simple and are using only the historic data for these four locations, but no other information or covariates.
At the end of this document ((#appendix-rnoaa)[Appendix A]), we also demonstrate a simple way to get historic temperature data for the four locations via the `rnoaa` package.


```{r}
library(tidyverse)
library(caret)
```


## Loading the data

The data for each of the three main sites is provided as simple text file in CSV format.
Each file contains the dates of the peak bloom of the cherry trees at the respective site, alongside the geographical location of the site.

The six columns in each data file are

* _location_ a human-readable location identifier (`string`).
* _lat_ (approximate) latitude of the cherry trees (`double`).
* _long_ (approximate) longitude of the cherry trees (`double`).
* _alt_ (approximate) altitude of the cherry trees (`double`).
* _year_ year of the observation (`integer`).
* *bloom_date* date of peak bloom of the cherry trees (ISO 8601 date `string`). The "peak bloom date" may be defined differently for different sites
* *bloom_doy* days since January 1st of the year until peak bloom (`integer`). January 1st corresponds to `1`.

In R, the data files can be read with `read.csv()` and concatenated with the `bind_rows()` function:

```{r}
# cherry <- read.csv("data/washingtondc.csv") %>% 
#   bind_rows(read.csv("data/liestal.csv")) %>% 
#   bind_rows(read.csv("data/kyoto.csv"))

cherry <- read.csv("data/InitCovariates.csv") %>%
  dplyr::select(-c("TmaxDaysSub0", "TmaxDaysSub5", "TmaxDaysSub10", "TmaxDaysSub20", "TmaxDaysSub25", "TminDaysSub0", "TminDaysSub5", "TminDaysSub10"))
```


## Visualizing the time series


```{r, fig.width=8, fig.height=3, out.width='100%', fig.cap="Time series of peak bloom of cherry trees since 1880 at three different sites."}
cherry %>% 
  filter(year >= 1880) %>%
  ggplot(aes(x = year, y = bloom_doy)) +
  geom_point() +
  geom_step(linetype = 'dotted', color = 'gray50') +
  scale_x_continuous(breaks = seq(1880, 2020, by = 20)) +
  facet_grid(cols = vars(str_to_title(location))) +
  labs(x = "Year", y = "Peak bloom (days since Jan 1st)")
```

```{r}
library(gbm)
library(dismo)

cherry_temp <- cherry %>%
  dplyr::select(-c("bloom_date"))

cherry_test <- cherry_temp %>%
  filter(year >= 2010)

cherry_train <- cherry_temp %>%
  filter(year <2010)

trControl <- trainControl(method = "cv", number = 10)

tuneGrid <- expand.grid(interaction.depth = c(1,3,5),n.trees = (5:10)*100, shrinkage = c(.1,.01), n.minobsinnode =10)


fullMod <- train(x = dplyr::select(cherry_train,-c("bloom_doy", "location")),
      y = cherry_train$bloom_doy,
      distribution = "gaussian",
      method="gbm",
      metric = "RMSE",
      tuneGrid = tuneGrid,
      trControl = trControl,
      verbose =F)

vars <- summary(fullMod$finalModel)$var

```


```{r Ensemble}
library(caretEnsemble)



mod_list <- caretList(
  x = dplyr::select(cherry_train,-c("bloom_doy", "location")),
  y = cherry_train$bloom_doy,
  trControl = trControl,
  methodList = c("gbm", "glm", "rf", "foba", "xgbTree", "svmLinear", "enet")
)


mod_stack <- caretStack(
  mod_list,
  method = "enet"
)

mod_ensemble <- caretEnsemble(
  mod_list
)

compPreds <- predict(mod_list, newdata = dplyr::select(cherry_test,-c("bloom_doy", "location")))
ensPreds <- predict(mod_ensemble, newdata = dplyr::select(cherry_test,-c("bloom_doy", "location")))
stackPreds <- predict(mod_stack, newdata = dplyr::select(cherry_test,-c("bloom_doy", "location")))

plot(cherry_test$bloom_doy, ensPreds, col = "black", ylim = c(80,100), pch=16)
points(cherry_test$bloom_doy, compPreds[,"glm"], col = "red", pch =16)
points(cherry_test$bloom_doy, compPreds[,"rf"], col = "blue", pch = 16)
points(cherry_test$bloom_doy, compPreds[,"gbm"], col = "green", pch = 16)
abline(a = 0, b = 1)
legend("topleft", legend = c("Ensemble", "GLM", "RF", "GBM"), col = c("black", "red", "blue", "green"), pch =16)


rmseEns <- sqrt(mean((ensPreds-cherry_test$bloom_doy)^2))

rmseStack <- sqrt(mean((stackPreds-cherry_test$bloom_doy)^2))

rmseGLM <- sqrt(mean((compPreds[,"glm"]-cherry_test$bloom_doy)^2))

rmseRF<- sqrt(mean((compPreds[,"rf"]-cherry_test$bloom_doy)^2))

rmseGBM<- sqrt(mean((compPreds[,"gbm"]-cherry_test$bloom_doy)^2))

rmseFOBA<- sqrt(mean((compPreds[,"foba"]-cherry_test$bloom_doy)^2))

rmseXGB<- sqrt(mean((compPreds[,"xgbTree"]-cherry_test$bloom_doy)^2))

rmseSVM<- sqrt(mean((compPreds[,"svmLinear"]-cherry_test$bloom_doy)^2))

rmseENET<- sqrt(mean((compPreds[,"enet"]-cherry_test$bloom_doy)^2))

fullEnsPerf <- c(rmseEns, rmseStack, rmseGLM, rmseRF, rmseGBM, rmseFOBA, rmseXGB, rmseSVM, rmseENET)

names(fullEnsPerf) <- c("Ens", "Stack","GLM", "RF", "GBM", "FOBA", "XGB", "SVM", "ENET")
```




```{r Variable Reduced Ensemble}
library(caretEnsemble)

subEnsPerf <- matrix(NA, nrow = 16, ncol = 9)

varIndex <- seq(5,35, by = 2)
for(i in 1:length(varIndex)){
cherry_test_sub <- cherry_test %>%
  dplyr::select(c(vars[1:varIndex[i]], "bloom_doy", "location"))

cherry_train_sub <- cherry_train %>%
  dplyr::select(c(vars[1:varIndex[i]], "bloom_doy", "location"))


mod_list <- caretList(
  x = dplyr::select(cherry_train_sub,-c("bloom_doy", "location")),
  y = cherry_train_sub$bloom_doy,
  trControl = trControl,
  methodList = c("gbm", "glm", "rf", "foba", "xgbTree", "svmLinear", "enet")
)


mod_stack <- caretStack(
  mod_list,
  method = "enet"
)

mod_ensemble <- caretEnsemble(
  mod_list
)

compPreds <- predict(mod_list, newdata = dplyr::select(cherry_test_sub,-c("bloom_doy", "location")))
ensPreds <- predict(mod_ensemble, newdata = dplyr::select(cherry_test_sub,-c("bloom_doy", "location")))
stackPreds <- predict(mod_stack, newdata = dplyr::select(cherry_test_sub,-c("bloom_doy", "location")))


rmseEns <- sqrt(mean((ensPreds-cherry_test_sub$bloom_doy)^2))

rmseStack <- sqrt(mean((stackPreds-cherry_test_sub$bloom_doy)^2))

rmseGLM <- sqrt(mean((compPreds[,"glm"]-cherry_test_sub$bloom_doy)^2))

rmseRF<- sqrt(mean((compPreds[,"rf"]-cherry_test_sub$bloom_doy)^2))

rmseGBM<- sqrt(mean((compPreds[,"gbm"]-cherry_test_sub$bloom_doy)^2))

rmseFOBA<- sqrt(mean((compPreds[,"foba"]-cherry_test_sub$bloom_doy)^2))

rmseXGB<- sqrt(mean((compPreds[,"xgbTree"]-cherry_test_sub$bloom_doy)^2))

rmseSVM<- sqrt(mean((compPreds[,"svmLinear"]-cherry_test_sub$bloom_doy)^2))

rmseENET<- sqrt(mean((compPreds[,"enet"]-cherry_test_sub$bloom_doy)^2))


subEnsPerf[i,] <- c(rmseEns, rmseStack, rmseGLM, rmseRF, rmseGBM, rmseFOBA, rmseXGB, rmseSVM, rmseENET)

}
colnames(subEnsPerf) <- c("Ens", "Stack","GLM", "RF", "GBM", "FOBA", "XGB", "SVM", "ENET")

```


```{r evaluate on next year for 10 years}

evalYears <- 2010:2021
evalYears <- evalYears[-6] # Get rid of 2015 because it's missing in switzerland

ensOneYearPerf <- matrix(NA, nrow = length(evalYears), ncol = 9)

for(i in 1:length(evalYears)){
  
  cherry_test_plus <- filter(cherry_test, year ==evalYears[i])
  cherry_train_plus <- bind_rows(cherry_train,
                                 filter(cherry_test, year < evalYears[i]))
  
  
  mod_list <- caretList(
    x = dplyr::select(cherry_train_plus,-c("bloom_doy", "location")),
    y = cherry_train_plus$bloom_doy,
    trControl = trControl,
    methodList = c("gbm", "glm", "rf", "foba", "xgbTree", "svmLinear", "enet"),
    verbose = F
  )
  
  
  mod_stack <- caretStack(
    mod_list,
    method = "enet"
  )
  
  mod_ensemble <- caretEnsemble(
    mod_list
  )
  
  compPreds <- predict(mod_list, newdata = dplyr::select(cherry_test_plus,-c("bloom_doy", "location")))
  ensPreds <- predict(mod_ensemble, newdata = dplyr::select(cherry_test_plus,-c("bloom_doy", "location")))
  stackPreds <- predict(mod_stack, newdata = dplyr::select(cherry_test_plus,-c("bloom_doy", "location")))
  
  
  rmseEns <- sqrt(mean((ensPreds-cherry_test_plus$bloom_doy)^2))
  
  rmseStack <- sqrt(mean((stackPreds-cherry_test_plus$bloom_doy)^2))
  
  rmseGLM <- sqrt(mean((compPreds[,"glm"]-cherry_test_plus$bloom_doy)^2))
  
  rmseRF<- sqrt(mean((compPreds[,"rf"]-cherry_test_plus$bloom_doy)^2))
  
  rmseGBM<- sqrt(mean((compPreds[,"gbm"]-cherry_test_plus$bloom_doy)^2))
  
  rmseFOBA<- sqrt(mean((compPreds[,"foba"]-cherry_test_plus$bloom_doy)^2))
  
  rmseXGB<- sqrt(mean((compPreds[,"xgbTree"]-cherry_test_plus$bloom_doy)^2))
  
  rmseSVM<- sqrt(mean((compPreds[,"svmLinear"]-cherry_test_plus$bloom_doy)^2))
  
  rmseENET<- sqrt(mean((compPreds[,"enet"]-cherry_test_plus$bloom_doy)^2))
  
  ensOneYearPerf[i,] <- c(rmseEns, rmseStack, rmseGLM, rmseRF, rmseGBM, rmseFOBA, rmseXGB, rmseSVM, rmseENET)
  
}


```